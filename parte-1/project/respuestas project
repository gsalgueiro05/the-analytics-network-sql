1--Ventas brutas, netas y margen--

SELECT extract(month from fecha) as mes,
round(sum(CASE
	when moneda='ARS' then venta/cotizacion_usd_peso
	when moneda='URU' then venta/cotizacion_usd_uru
	when moneda='EUR' then venta/cotizacion_usd_eur
	else 0
	end),2) as venta_bruta_usd,
	
round(sum(CASE
	when moneda='ARS' then (venta-impuestos)/cotizacion_usd_peso
	when moneda='URU' then (venta-impuestos)/cotizacion_usd_uru
	when moneda='EUR' then (venta-impuestos)/cotizacion_usd_eur
	else 0
	end),2) as venta_neta_usd,
	
round(sum((CASE
	when moneda='ARS' then (venta+coalesce(descuento,0)+coalesce(creditos,0))/cotizacion_usd_peso
	when moneda='URU' then (venta+coalesce(descuento,0)+coalesce(creditos,0))/cotizacion_usd_uru
	when moneda='EUR' then (venta+coalesce(descuento,0)+coalesce(creditos,0))/cotizacion_usd_eur
	else 0
	end)- c1.costo_promedio_usd),2) as margen_usd
	
from stg.order_line_sale as ols
LEFT JOIN stg.monthly_average_fx_rate as mafr
ON extract(month from mafr.mes)=extract(month from ols.fecha)
LEFT JOIN stg.cost as c1
ON c1.codigo_producto=ols.producto
GROUP BY extract(month from fecha)
ORDER BY extract(month from fecha)

2--Margen por categoría de producto--

SELECT extract(month from fecha) as mes, categoria,
round(sum((CASE
	when moneda='ARS' then (venta+coalesce(descuento,0)+coalesce(creditos,0))/cotizacion_usd_peso
	when moneda='URU' then (venta+coalesce(descuento,0)+coalesce(creditos,0))/cotizacion_usd_uru
	when moneda='EUR' then (venta+coalesce(descuento,0)+coalesce(creditos,0))/cotizacion_usd_eur
	else 0
	end)- c1.costo_promedio_usd),2) as margen_usd
	
from stg.order_line_sale as ols
LEFT JOIN stg.monthly_average_fx_rate as mafr
ON extract(month from mafr.mes)=extract(month from ols.fecha)
LEFT JOIN stg.cost as c1
ON c1.codigo_producto=ols.producto
LEFT JOIN stg.product_master as pm
ON pm.codigo_producto=ols.producto
GROUP BY categoria, extract(month from fecha)
ORDER BY extract(month from fecha)

3--ROI por categoria de producto--

WITH CTE_inventario AS (
	SELECT
		tienda,
		ROUND (AVG((inicial+final)/2),2) AS inventario_promedio,
		INV.sku
	FROM stg.inventory AS INV
	GROUP BY sku, tienda
	ORDER BY sku
),
CTE_ventas AS (
	SELECT 
		tienda,
		EXTRACT (month FROM fecha) AS mes_venta,
		ROUND (SUM (CASE 
		when moneda='ARS' then (venta-impuestos)/cotizacion_usd_peso
		when moneda='URU' then (venta-impuestos)/cotizacion_usd_uru
		when moneda='EUR' then (venta-impuestos)/cotizacion_usd_eur
		else 0
		end),2) as venta_neta_usd
	FROM stg.order_line_sale AS ols
	LEFT JOIN stg.monthly_average_fx_rate AS mafr
		ON extract(month from mafr.mes)=extract(month from ols.fecha)
	GROUP BY mes_venta, tienda
)
SELECT 
	categoria,
	ROUND ((SUM(inventario_promedio)/SUM(venta_neta_usd)*100),2) AS ROI
FROM CTE_inventario AS INV
LEFT JOIN CTE_ventas AS OLS
	ON INV.tienda = OLS.tienda
LEFT JOIN stg.product_master AS PM
	ON INV.sku = PM.codigo_producto
GROUP BY categoria

4 --AOV--

WITH VTA_USD AS 
(SELECT orden, extract(month from fecha) as mes,
round(CASE 
	when moneda='ARS' then venta/cotizacion_usd_peso
	when moneda='URU' then venta/cotizacion_usd_uru
	when moneda='EUR' then venta/cotizacion_usd_eur
	else 0
	end,2) as venta_bruta_usd

FROM stg.order_line_sale as ols
LEFT JOIN stg.monthly_average_fx_rate as mafr
ON extract(month from mafr.mes)=extract(month from ols.fecha)
)

SELECT mes, round(sum(venta_bruta_usd)/count(distinct orden),2)as AOV
FROM VTA_USD
GROUP BY mes

5-- Impuestos pagados--

SELECT extract (month from fecha) as mes,
round(sum(CASE
	when moneda='ARS' then impuestos/cotizacion_usd_peso
	when moneda='EUR' then impuestos/cotizacion_usd_eur
	when moneda='URU' then impuestos/cotizacion_usd_uru
	else 0
	end),2) as impuestos_usd
	
FROM stg.order_line_sale as ols
LEFT JOIN stg.monthly_average_fx_rate as mafr
ON extract(month from mafr.mes)=extract(month from ols.fecha)
GROUP BY extract (month from fecha)

6--Tasa de impuesto--

SELECT extract (month from fecha) as mes,
round(sum(CASE
	when moneda='ARS' then impuestos/cotizacion_usd_peso
	when moneda='EUR' then impuestos/cotizacion_usd_eur
	when moneda='URU' then impuestos/cotizacion_usd_uru
	else 0
	end),2) as impuestos_usd
	
FROM stg.order_line_sale as ols
LEFT JOIN stg.monthly_average_fx_rate as mafr
ON extract(month from mafr.mes)=extract(month from ols.fecha)
GROUP BY extract (month from fecha)
ORDER BY extract (month from fecha)

7--Cantidad de créditos otorgados--

SELECT
	extract (month FROM fecha) as mes,
	COUNT (creditos)
FROM stg.order_line_sale
GROUP BY mes
